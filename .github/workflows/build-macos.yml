name: Build macOS App

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install py2app & deps
        run: |
          python3 -m pip install --upgrade pip
          # make sure py2app is there
          pip install py2app
          # then install your other requirements
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build .app with py2app
        run: |
          python3 setup.py py2app || echo "py2app failed with $?"

      - name: Debug show entire workspace
        run: |
          echo "==== ROOT ===="
          ls -R .
          # then look for any dist or build.
   
      - name: Find and zip the .app
        run: |
          # if py2app created dist/, zip that
          if [ -d dist ]; then
            cd dist
            zip -r ../macos_app_bundle.zip .
            cd ..
          else
            # otherwise, zip whatever .app you find
            found=$(find . -maxdepth 2 -type d -name "*.app" | head -n1)
            echo "Found .app at: $found"
            zip -r macos_app_bundle.zip "$found"
          fi
          ls -l macos_app_bundle.zip

      - name: Upload macOS ZIP
        uses: actions/upload-artifact@v2
        with:
          name: macos-app
          path: macos_app_bundle.zip
